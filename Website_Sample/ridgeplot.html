<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>NYC Rent YoY — Ridge Plot by Year (Select Group)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 22px
        }

        .sub {
            margin: 0 0 12px;
            opacity: .8
        }

        .card {
            background: #fff;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px
        }

        select {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid #dfe3ee;
            background: #f8f9fc
        }

        #ridge {
            height: 500px
        }

        .note {
            font-size: 12px;
            opacity: .7;
            margin-top: 6px
        }
    </style>
</head>

<body>

    <div class="card">
        <div class="toolbar">
            <label for="groupSel">Group:</label>
            <select id="groupSel">
                <option>Manhattan (Doorman)</option>
                <option>Manhattan (Non-Doorman)</option>
                <option>Brooklyn</option>
                <option>Queens</option>
                <option>Bronx</option>
            </select>
        </div>
        <div id="ridge"></div>
        <div class="note">Each ridge = KDE (density) of neighborhood YoY change in a year-bucket for the selected group. <br>
            Use the selector to switch groups.</div>
    </div>

    <script>
        const man1 = [
            { name: '13-14', y: [3.16, 0.57, 4.24, -0.61, -7.45, -1.68, 13.2, 6.07, -4.69, 0.81, 0.92, -6.89, -1.68, -0.39, 1.28] },
            { name: '14-15', y: [6.44, 6.56, 10.36, 4.26, 6.83, 1.07, 16.36, 5.22, 1.10, 1.34, 0.81, 18.25, 5.33, 2.68, 3.18] },
            { name: '15-16', y: [0.7, -0.22, -0.78, 0.4, -2.95, 3.1, -5.62, -5.93, -0.54, -2.55, -2.9, 0.34, 4.03, 0.69, 0.39] },
            { name: '16-17', y: [1.05, -6.35, -2.16, 0.21, -2.27, 3.01, 3.71, 1.73, 1.37, -1.14, -0.34, 5.45, -4.33, 0.89, -1.85] },
            { name: '17-18', y: [0.24, 4.89, -4.86, -2.43, 1.97, 2.37, -2.23, 4.38, -0.24, 0.79, 4.06, -2.59, 1.67, 1.77, 1.13] },
            { name: '18-19', y: [3.3, 3.24, 9.05, 3.85, 4.72, 2.76, 0.34, 10.69, 6.11, 2.29, 3.9, -0.75, 1.08, 3.37, 2.39] },
            { name: '19-20', y: [-4.61, -7.83, -10.81, -6.17, -5.77, -4.07, -1.4, -8.28, -6.43, -8.38, -8.57, 0.03, -2.56, -5.48, -5.33] },
            { name: '20-21', y: [-2.91, 6.2, 2.79, 6.82, 0.67, -2.24, -9.95, 4.57, -0.49, 3.77, 2.75, -1.12, 1.47, -3.08, 3.14] },
            { name: '21-22', y: [18.41, 19.35, 20.46, 20.75, 15.55, 20.16, 21.37, 22.30, 20.28, 22.49, 20.12, 19.62, 21] }
        ];

        const man2 = [
            { name: '13-14', y: [-1.49, -1.86, 2.43, -3.41, 3.33, 2.29, 0.79, 0.19, -4.46, -2.12, -4.12, -3.29, -2.05, -0.1] },
            { name: '14-15', y: [0.7, -2.74, 5.03, -1.34, -0.11, 5.4, -1.31, -5.31, 1.77, -1.88, 6.08, -5.51, 1.98, 0.45] },
            { name: '15-16', y: [-7.73, 12.99, -14.11, 3.96, -11.23, 45.85, 16.54, 10.12, 15.09, 7.46, -13.27, -33.86, 20.25, 11.93] },
            { name: '16-17', y: [1.45, 1.79, 0.97, 1.4, 1.25, 1.55, 1.27, 1.76, 1.39, 1.87, 1.85, 0.91, 1.49, 1.4] },
            { name: '17-18', y: [-0.53, -0.64, 0.44, -0.99, -0.29, -0.59, -0.7, -1.12, -0.7, -0.97, -1.01, 0.27, -0.7, -1.11] },
            { name: '18-19', y: [1.14, 1.25, -0.06, 1, 1.03, 0.88, 0.92, 0.86, 0.74, 0.58, 0.61, 0.54, 0.8, 1.31] },
            { name: '19-20', y: [0.65, 0.51, 0.15, 0.78, -0.18, 0.78, 0.58, -0.24, 0.15, -0.06, -0.14, -1.54, -0.12, -3.25] },
            { name: '20-21', y: [-16.58, -16.26, -16.88, -17.19, -16.02, -17.1, -16.63, -16.39, -16.56, -16.24, -17, -13.57, -16.29, -13.36] },
            { name: '21-22', y: [28.1, 26.61, 27.26, 28.46, 27.78, 26.58, 27.45, 28.27, 27.76, 28.5, 26.69, 25.57, 28.6, 27.57] }
        ];

        const bk = [
            { name: '13-14', y: [6.72, 7.74, 4.55, 0.21, 5.43, 4.02, 6.36, 12.4, 3.05, 3.5, 3.55, 0.25, 1.47, 3.99, -0.12] },
            { name: '14-15', y: [2.18, 2.43, 5.32, 1, -0.76, 1.18, 0, -4.3, 2.29, 5.85, 2.03, -4.9, 1.53, 0.58, 5.08] },
            { name: '15-16', y: [5.18, 7.61, -3.37, -0.27, 4.13, 1.25, 4.6, 9.62, 2, -2.85, 4.85, 1.56, -0.83, 12.07, -5.59] },
            { name: '16-17', y: [-1.15, 0.56, 0, 3.46, 0.09, -0.31, -3.71, -0.05, -0.28, 3.71, -1.44, -1.02, -0.87, 2.94, -3.73] },
            { name: '17-18', y: [0.66, 1.58, -0.62, 0.2, 4.47, 2.55, 2.15, 3.49, -18.42, 29.41, 3.91, -0.33, 3.37, 4.96, -3.88] },
            { name: '18-19', y: [1.76, 3.12, 5.12, 10.24, 7.55, 7.99, 2.24, 2.87, 27, -16.95, 5.14, 13, 4.48, 1, 9.71] },
            { name: '19-20', y: [0.27, -0.98, 1.5, -7.19, -3, -4.05, -2.55, -2.48, -23.65, 17.8, -3.34, -1.67, -4.89, -1.28, -2.98] },
            { name: '20-21', y: [-1.4, 0.99, -8.99, -2.95, 3.09, -1.82, 0.54, -2.14, 5.79, -2.28, -0.22, -0.89, -2.15, -0.81] },
            { name: '21-22', y: [7.38, 17.53, 21.03, 26.04, 15.39, 29.64, 23.29, 17.32, 23.36, 18.85, 27.84, 33.36, 22.59, 16.67, 25.24] }
        ];

        const queen = [
            { name: '17-18', y: [-1.01, -2.07, 2.89, 1.38, 6.3, 1.85, 0.71] },
            { name: '18-19', y: [2.59, -1.1, 2.38, 2.25, 5.89, 3.44, 3.91] },
            { name: '19-20', y: [-1.72, 4.99, 0.33, 3.17, -4.21, -0.18, -1.01] },
            { name: '20-21', y: [-4.04, -3.19, -4.68, -3.12, 1.81, 1.2, 0.34] },
            { name: '21-22', y: [22.26, 3.53, 12.48, 7.67, 25.51, 3.47, 15.93] }
        ];

        const br = [
            { name: '20-21', y: [0.06, -1.67, 8.36, 4.63] },
            { name: '21-22', y: [5.38, 7.83, 18.93, 3.93] }
        ];

        const GROUPS = {
            'Manhattan (Doorman)': man1,
            'Manhattan (Non-Doorman)': man2,
            'Brooklyn': bk,
            'Queens': queen,
            'Bronx': br
        };

        function kde(xs, bandwidth = 1.2) {
            const invSqrt2Pi = 1 / Math.sqrt(2 * Math.PI);
            return function (x) {
                let sum = 0;
                for (let i = 0; i < xs.length; i++) {
                    const z = (x - xs[i]) / bandwidth;
                    sum += Math.exp(-0.5 * z * z) * invSqrt2Pi;
                }
                return sum / (xs.length * bandwidth);
            };
        }

        function renderRidge(label) {
            const data = GROUPS[label];
            const all = data.flatMap(d => d.y);
            const xmin = Math.min(...all), xmax = Math.max(...all);
            const pad = 2;
            const xStart = Math.floor(xmin - pad), xEnd = Math.ceil(xmax + pad);
            const xgrid = [];
            for (let x = xStart; x <= xEnd; x += 0.2) { xgrid.push(x); }

            const periods = data.map(d => d.name);

            const offset = 1.2;

            const traces = [];
            for (let i = 0; i < data.length; i++) {
                const bucket = data[i];
                const densFn = kde(bucket.y, 1.4); 
                const dens = xgrid.map(x => densFn(x));

                const maxD = Math.max(...dens) || 1;
                const scaled = dens.map(v => v / maxD);

                const yline = scaled.map(v => v + i * offset);
                const ybase = xgrid.map(_ => i * offset);

                const colors = xgrid.map(x => x >= 0 ? 'rgb(203,67,53)' : 'rgb(52,152,219)');

                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: xgrid,
                    y: yline,
                    line: { width: 1.5, color: '#333' },
                    fill: 'tonexty',
                    fillcolor: 'rgba(0,0,0,0)', 
                    name: bucket.name,
                    hovertemplate:
                        '<b>' + bucket.name + '</b><br>' +
                        'Value: %{x:.1f}%<br>' +
                        'Density: %{y:.2f}<extra></extra>'
                });

                traces.push({
                    type: 'scatter',
                    mode: 'lines',
                    x: xgrid,
                    y: ybase,
                    line: { width: 0 },
                    fill: 'tonexty',
                    fillcolor: 'rgba(0,0,0,0)',
                    hoverinfo: 'skip',
                    showlegend: false
                });

                const fillColor = 'rgba(' + (xStart >= 0 ? '203,67,53' : '52,152,219') + ',0.25)';
                traces[traces.length - 2].fillcolor = 'rgba(0,0,0,0)'; 
                traces[traces.length - 1].fillcolor = 'rgba(0,0,0,0)'; 
            }

            const layout = {
                paper_bgcolor: '#fff', plot_bgcolor: '#fff',
                title: { text: 'Ridge Plot — ' + label + ' (YoY density by year-bucket)', x: 0, xanchor: 'left' },
                xaxis: { title: 'YoY rent change (%)', zerolinecolor: '#ccc', gridcolor: '#f0f0f0' },
                yaxis: {
                    title: '',
                    tickmode: 'array',
                    tickvals: periods.map((_, i) => i * offset + 0.5),
                    ticktext: periods,
                    showgrid: false
                },
                margin: { l: 120, r: 24, t: 56, b: 50 },
                showlegend: false
            };

            Plotly.newPlot('ridge', traces, layout, {
                responsive: true, displaylogo: false,
                modeBarButtonsToRemove: ['toImage', 'toggleSpikelines', 'zoom2d', 'pan2d']
            });
        }

        const sel = document.getElementById('groupSel');
        sel.value = 'Manhattan (Doorman)';
        renderRidge(sel.value);
        sel.addEventListener('change', e => renderRidge(e.target.value));
    </script>
</body>

</html>