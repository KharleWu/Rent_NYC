<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 22px
        }

        .sub {
            margin: 0 0 16px;
            opacity: .85
        }

        .card {
            background: #fff;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f0f2f7;
            border-radius: 12px;
            padding: 6px 10px;
            font-size: 14px;
            user-select: none
        }

        #violin {
            height: 680px
        }

        .note {
            font-size: 12px;
            opacity: .7;
            margin-top: 6px
        }
    </style>
</head>

<body>
    <div class="card">
        <div class="controls" id="controls"></div>
        <div id="violin"></div>
        <div class="note">Each violin = neighborhood YoY distribution within a year-bucket (<b>clipped to ±1.5×IQR</b>).
            Outliers are shown as small dots.</div>
        <div class="note">Violin is clipped to the former boxplot whiskers (<b>Q1–Q3 ± 1.5×IQR</b>), while values outside are plotted as
            separate outlier points.
        </div>
    </div>

    <script>
        const man1 = [{ name: '13-14', y: [3.16, 0.57, 4.24, -0.61, -7.45, -1.68, 13.2, 6.07, -4.69, 0.81, 0.92, -6.89, -1.68, -0.39, 1.28] },
        { name: '14-15', y: [6.44, 6.56, 10.36, 4.26, 6.83, 1.07, 16.36, 5.22, 1.10, 1.34, 0.81, 18.25, 5.33, 2.68, 3.18] },
        { name: '15-16', y: [0.7, -0.22, -0.78, 0.4, -2.95, 3.1, -5.62, -5.93, -0.54, -2.55, -2.9, 0.34, 4.03, 0.69, 0.39] },
        { name: '16-17', y: [1.05, -6.35, -2.16, 0.21, -2.27, 3.01, 3.71, 1.73, 1.37, -1.14, -0.34, 5.45, -4.33, 0.89, -1.85] },
        { name: '17-18', y: [0.24, 4.89, -4.86, -2.43, 1.97, 2.37, -2.23, 4.38, -0.24, 0.79, 4.06, -2.59, 1.67, 1.77, 1.13] },
        { name: '18-19', y: [3.3, 3.24, 9.05, 3.85, 4.72, 2.76, 0.34, 10.69, 6.11, 2.29, 3.9, -0.75, 1.08, 3.37, 2.39] },
        { name: '19-20', y: [-4.61, -7.83, -10.81, -6.17, -5.77, -4.07, -1.4, -8.28, -6.43, -8.38, -8.57, 0.03, -2.56, -5.48, -5.33] },
        { name: '20-21', y: [-2.91, 6.2, 2.79, 6.82, 0.67, -2.24, -9.95, 4.57, -0.49, 3.77, 2.75, -1.12, 1.47, -3.08, 3.14] },
        { name: '21-22', y: [18.41, 19.35, 20.46, 20.75, 15.55, 20.16, 21.37, 22.30, 20.28, 22.49, 20.12, 19.62, 21] }];

        const man2 = [{ name: '13-14', y: [-1.49, -1.86, 2.43, -3.41, 3.33, 2.29, 0.79, 0.19, -4.46, -2.12, -4.12, -3.29, -2.05, -0.1] },
        { name: '14-15', y: [0.7, -2.74, 5.03, -1.34, -0.11, 5.4, -1.31, -5.31, 1.77, -1.88, 6.08, -5.51, 1.98, 0.45] },
        { name: '15-16', y: [-7.73, 12.99, -14.11, 3.96, -11.23, 45.85, 16.54, 10.12, 15.09, 7.46, -13.27, -33.86, 20.25, 11.93] },
        { name: '16-17', y: [1.45, 1.79, 0.97, 1.4, 1.25, 1.55, 1.27, 1.76, 1.39, 1.87, 1.85, 0.91, 1.49, 1.4] },
        { name: '17-18', y: [-0.53, -0.64, 0.44, -0.99, -0.29, -0.59, -0.7, -1.12, -0.7, -0.97, -1.01, 0.27, -0.7, -1.11] },
        { name: '18-19', y: [1.14, 1.25, -0.06, 1, 1.03, 0.88, 0.92, 0.86, 0.74, 0.58, 0.61, 0.54, 0.8, 1.31] },
        { name: '19-20', y: [0.65, 0.51, 0.15, 0.78, -0.18, 0.78, 0.58, -0.24, 0.15, -0.06, -0.14, -1.54, -0.12, -3.25] },
        { name: '20-21', y: [-16.58, -16.26, -16.88, -17.19, -16.02, -17.1, -16.63, -16.39, -16.56, -16.24, -17, -13.57, -16.29, -13.36] },
        { name: '21-22', y: [28.1, 26.61, 27.26, 28.46, 27.78, 26.58, 27.45, 28.27, 27.76, 28.5, 26.69, 25.57, 28.6, 27.57] }];

        const bk = [{ name: '13-14', y: [6.72, 7.74, 4.55, 0.21, 5.43, 4.02, 6.36, 12.4, 3.05, 3.5, 3.55, 0.25, 1.47, 3.99, -0.12] },
        { name: '14-15', y: [2.18, 2.43, 5.32, 1, -0.76, 1.18, 0, -4.3, 2.29, 5.85, 2.03, -4.9, 1.53, 0.58, 5.08] },
        { name: '15-16', y: [5.18, 7.61, -3.37, -0.27, 4.13, 1.25, 4.6, 9.62, 2, -2.85, 4.85, 1.56, -0.83, 12.07, -5.59] },
        { name: '16-17', y: [-1.15, 0.56, 0, 3.46, 0.09, -0.31, -3.71, -0.05, -0.28, 3.71, -1.44, -1.02, -0.87, 2.94, -3.73] },
        { name: '17-18', y: [0.66, 1.58, -0.62, 0.2, 4.47, 2.55, 2.15, 3.49, -18.42, 29.41, 3.91, -0.33, 3.37, 4.96, -3.88] },
        { name: '18-19', y: [1.76, 3.12, 5.12, 10.24, 7.55, 7.99, 2.24, 2.87, 27, -16.95, 5.14, 13, 4.48, 1, 9.71] },
        { name: '19-20', y: [0.27, -0.98, 1.5, -7.19, -3, -4.05, -2.55, -2.48, -23.65, 17.8, -3.34, -1.67, -4.89, -1.28, -2.98] },
        { name: '20-21', y: [-1.4, 0.99, -8.99, -2.95, 3.09, -1.82, 0.54, -2.14, 5.79, -2.28, -0.22, -0.89, -2.15, -0.81] },
        { name: '21-22', y: [7.38, 17.53, 21.03, 26.04, 15.39, 29.64, 23.29, 17.32, 23.36, 18.85, 27.84, 33.36, 22.59, 16.67, 25.24] }];

        const queen = [{ name: '17-18', y: [-1.01, -2.07, 2.89, 1.38, 6.3, 1.85, 0.71] },
        { name: '18-19', y: [2.59, -1.1, 2.38, 2.25, 5.89, 3.44, 3.91] },
        { name: '19-20', y: [-1.72, 4.99, 0.33, 3.17, -4.21, -0.18, -1.01] },
        { name: '20-21', y: [-4.04, -3.19, -4.68, -3.12, 1.81, 1.2, 0.34] },
        { name: '21-22', y: [22.26, 3.53, 12.48, 7.67, 25.51, 3.47, 15.93] }];

        const br = [{ name: '20-21', y: [0.06, -1.67, 8.36, 4.63] },
        { name: '21-22', y: [5.38, 7.83, 18.93, 3.93] }];

        const GROUPS = {
            'Manhattan (Doorman)': { data: man1, color: '#f5a623' },
            'Manhattan (Non-Doorman)': { data: man2, color: '#7f8c8d' },
            'Brooklyn': { data: bk, color: '#4C78A8' },
            'Queens': { data: queen, color: '#2AA198' },
            'Bronx': { data: br, color: '#D35400' }
        };

        // ---------- Stats helpers: quantile / IQR bounds / split inliers & outliers ----------
        function quantile(arr, q) {
            const a = arr.slice().sort((x, y) => x - y);
            if (a.length === 0) return NaN;
            const pos = (a.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            return (a[base + 1] !== undefined) ? a[base] + rest * (a[base + 1] - a[base]) : a[base];
        }
        function iqrBounds(values, k = 1.5) {
            if (!values || values.length < 4) return { low: -Infinity, high: Infinity, q1: NaN, q3: NaN };
            const q1 = quantile(values, 0.25);
            const q3 = quantile(values, 0.75);
            const iqr = q3 - q1;
            return { low: q1 - k * iqr, high: q3 + k * iqr, q1, q3 };
        }
        function splitByIQR(values, k = 1.5) {
            const { low, high } = iqrBounds(values, k);
            const inliers = [], outliers = [];
            for (const v of values) {
                if (v < low || v > high) outliers.push(v); else inliers.push(v);
            }
            return { inliers, outliers, low, high };
        }

        const periods = Array.from(new Set(
            Object.values(GROUPS).flatMap(g => g.data.map(d => d.name))
        )).sort((a, b) => {
            const ax = a.split('-').map(Number), bx = b.split('-').map(Number);
            return ax[0] - bx[0] || ax[1] - bx[1];
        });

        const controlsDiv = document.getElementById('controls');
        Object.keys(GROUPS).forEach(label => {
            const wrap = document.createElement('label'); wrap.className = 'chip';
            const cb = document.createElement('input'); cb.type = 'checkbox';
            cb.checked = (label === 'Manhattan (Doorman)'); cb.dataset.label = label;
            cb.addEventListener('change', render);
            const dot = document.createElement('span'); Object.assign(dot.style, { width: '10px', height: '10px', display: 'inline-block', background: GROUPS[label].color, borderRadius: '50%' });
            const txt = document.createElement('span'); txt.textContent = label;
            wrap.appendChild(cb); wrap.appendChild(dot); wrap.appendChild(txt); controlsDiv.appendChild(wrap);
        });

        function render() {
            const on = Array.from(document.querySelectorAll('.controls input[type=checkbox]:checked'))
                .map(el => el.dataset.label);

            const traces = [];
            on.forEach(label => {
                const { data, color } = GROUPS[label];

                data.forEach(bucket => {
                    const { inliers, outliers, low, high } = splitByIQR(bucket.y, 1.5);

                    const ymin = inliers.length ? Math.min(...inliers) : low;
                    const ymax = inliers.length ? Math.max(...inliers) : high;

                    traces.push({
                        type: 'violin',
                        name: label,
                        legendgroup: label, scalegroup: label,
                        x: Array(inliers.length).fill(bucket.name),
                        y: inliers,
                        line: { color: color },
                        fillcolor: color + '33',
                        box: { visible: false },        
                        meanline: { visible: true },      
                        points: false,                  
                        spanmode: 'manual',             
                        span: [low, high],
                        opacity: 0.95,
                        hovertemplate:
                            '<b>%{x}</b><br>' + label +
                            '<br>YoY: %{y:.1f}%<extra></extra>',
                        showlegend: false
                    });

                    if (outliers.length) {
                        traces.push({
                            type: 'scatter',
                            mode: 'markers',
                            name: label + ' — outliers',
                            x: Array(outliers.length).fill(bucket.name),
                            y: outliers,
                            marker: { size: 5, color: color, opacity: 0.85, symbol: 'circle-open' },
                            hovertemplate:
                                '<b>%{x}</b><br>' + label + ' (outlier)' +
                                '<br>YoY: %{y:.1f}%<extra></extra>',
                            showlegend: false
                        });
                    }
                });
            });

            const layout = {
                paper_bgcolor: '#fff', plot_bgcolor: '#fff',
                title: { text: 'Violin by Year × Borough (clipped to ±1.5×IQR; outliers as points)', x: 0, xanchor: 'left' },
                xaxis: { title: 'Year bucket', categoryorder: 'array', categoryarray: periods },
                yaxis: { title: 'YoY rent change (%)', zerolinecolor: '#ccc', gridcolor: '#f0f0f0' },
                margin: { l: 64, r: 24, t: 56, b: 50 },
                showlegend: false
            };

            Plotly.newPlot('violin', traces, layout, {
                responsive: true, displaylogo: false,
                modeBarButtonsToRemove: ['toImage', 'toggleSpikelines', 'zoom2d', 'pan2d']
            });
        }

        render();
    </script>
</body>

</html>